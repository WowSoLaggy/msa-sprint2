stages:
  - build
  - test
  - deploy
  - tag

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: booking-service
  DOCKERFILE_PATH: booking-service/Dockerfile
  HELM_CHART_PATH: helm/booking-service

build:
  stage: build
  script:
    - echo "Building Docker image..."
    - cd booking-service
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - echo "Docker image built successfully"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

test:
  stage: test
  script:
    - echo "Starting container for testing..."
    - CONTAINER_ID=$(docker run -d -p 8080:8080 ${IMAGE_NAME}:${IMAGE_TAG})
    - echo "Container started with ID $CONTAINER_ID"
    - echo "Waiting for service to start..."
    - sleep 15
    - echo "Testing /ping endpoint..."
    - curl -f http://localhost:8080/ping
    - echo "✅ /ping endpoint test passed"
    - echo "Cleaning up test container..."
    - docker rm -f $CONTAINER_ID
    - echo "Test completed successfully"
  dependencies:
    - build
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

deploy:
  stage: deploy
  script:
    - echo "Loading image into Minikube..."
    - minikube image load ${IMAGE_NAME}:${IMAGE_TAG}
    - echo "Image loaded into Minikube successfully"
    - echo "Deploying to Kubernetes using Helm..."
    - helm upgrade --install booking-service ${HELM_CHART_PATH} --set image.name=${IMAGE_NAME} --set image.tag=${IMAGE_TAG} --wait --timeout=300s
    - echo "Deployment completed successfully"
    - echo "Checking deployment status..."
    - kubectl get deployment booking-service
    - kubectl get service booking-service
    - kubectl get pods -l app.kubernetes.io/name=booking-service
  dependencies:
    - test
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"

tag:
  stage: tag
  script:
    - echo "Creating Git tag..."
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    - git tag -a "deploy_$(date +%Y%m%d_%H%M%S)" -m "Deployment tag"
    - echo "✅ Tag created successfully"
  dependencies:
    - deploy
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
  when: manual
 